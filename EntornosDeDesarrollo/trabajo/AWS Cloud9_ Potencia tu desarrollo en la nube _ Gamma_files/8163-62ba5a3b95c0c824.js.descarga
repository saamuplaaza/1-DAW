"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8163],{21755:function(t,e,n){n.d(e,{n:function(){return s}});var o=n(62564),r=n(2784),i=n(37914),a=n(98875),s=function(t){var e=(0,a.ye)("debugLogging");(0,r.useEffect)(function(){if(t){if(e){console.debug("[Prosemirror DevTools] Activating prosemirror-dev-tools");try{(0,o.h)(t.view)}catch(t){}}else(0,o.P)();return i.v.DEBUG_ENABLED&&(window.openPMDT=function(){return(0,o.h)(t.view)}),function(){(0,o.P)(),delete window.openPMDT}}},[t,e])}},87880:function(t,e,n){n.d(e,{f:function(){return p}});var o=n(95235),r=n(82269),i=n(23769),a=n(43997),s=n(19700),c=n(82477),u=n(52322),l=["reduxData"];function d(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function f(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?d(Object(n),!0).forEach(function(e){(0,o.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var p=function(t){var e=(0,i.Z)({},t),n=e.reduxData,o=(0,r.Z)(e,l),d=(0,s.c)(n);return(0,u.jsx)(a.zt,{store:d,children:(0,u.jsx)(c.y,f(f({},o),{},{readOnly:!0,isStatic:!0,animationsEnabled:!1}))})}},57461:function(t,e,n){n.d(e,{F:function(){return a}});var o=n(72338),r=n(65470),i=n(51784),a=o.hj.create({name:"animations",addOptions:function(){return{}},addCommands:function(){return{addAnimationPositions:function(t,e){return function(n){var o=n.state;return n.dispatch&&o.tr.setMeta(i.$,{type:"addAnimationPositions",isPresentMode:e,pos:t}),!0}},enableAnimations:function(t){return function(e){var n=e.state;return e.dispatch&&n.tr.setMeta(i.$,{type:"enableAnimations",enabled:t}),!0}},resetAnimationPositions:function(t){return function(e){var n=e.state;return e.dispatch&&n.tr.setMeta(i.$,{type:"resetAnimationPositions",isPresentMode:t}),!0}}}},addProseMirrorPlugins:function(){return[(0,r.Q2)()]}})},65470:function(t,e,n){n.d(e,{GD:function(){return E},VM:function(){return C},Q2:function(){return T},jJ:function(){return x},PY:function(){return Z}});var o=n(72338),r=n(27191),i=n(52780),a=n(46358),s=n(62141),c=n(26087),u=n(12691),l=n(47592),d=n(42545),f=n(20046),p=n(82360),h=n(24336),v=n(51784),m=n(96412),g=n(13089),y=n(95235),b=n(38564),w=n(98875),A=n(39428),k=n(71672),S=n(49392),P=function(){return{absPositions:[],relPositions:[]}},M=function(){function t(){(0,m.Z)(this,t),(0,y.Z)(this,"enabled",void 0),(0,y.Z)(this,"presentModePositions",P()),(0,y.Z)(this,"editModePositions",P());var e="true"===k.W.getItem(S.H.editorAnimationsEnabled);this.enabled=w.VH.get("editorAnimationsEnabled")||e}return(0,g.Z)(t,[{key:"getPositions",value:function(t){return t?this.presentModePositions:this.editModePositions}},{key:"apply",value:function(t,e){var n=t.getMeta(v.$);if(n)switch(n.type){case"addAnimationPositions":this.addAnimationPositions(n.pos,e,n.isPresentMode);break;case"resetAnimationPositions":this.resetAnimationPositions(n.isPresentMode);break;case"enableAnimations":this.enabled=n.enabled;break;default:console.warn("AnimationsState: unknown action type",n)}return this}},{key:"addAnimationPositions",value:function(t,e,n){var o=this.getPositions(n);t.forEach(function(t){o.absPositions.push(t);var n=(0,A.jS)(e,t);n&&o.relPositions.push(n)})}},{key:"resetAnimationPositions",value:function(t){t?this.presentModePositions=P():this.editModePositions=P()}},{key:"getAnimationPositionsAbs",value:function(t,e){var n=b.Gt.getState(t),o=this.getPositions(e);return n?o.relPositions.map(function(e){return(0,A.XV)(t,e)}).filter(Boolean):o.absPositions}}]),t}(),D="animate-has-animated",E="animatable-on-load",C="animatable-on-load-content-parent",O="animatable-on-load-content-child",j=function(t){switch(t.type.name){case"card":return!0===(0,l.HD)(t);case"cardAccentLayoutItem":return(0,d.pt)(t);case"gallery":case"smartLayout":return!0;default:return(0,h.yV)(t)}},I=function(t,e){return(0,p.E)(t)||(0,f.u5)(e)},x=function(t){t.classList.add(D),t.classList.contains(C)&&t.querySelectorAll(".".concat(O)).forEach(function(t){t.classList.add(D)})},Z=function(t,e){var n=t.view.state.doc.resolve(e);if(n){var r=t.state.doc.nodeAt(e);if(r&&j(r)&&!I(r,n)){var i=r.isLeaf||r.isAtom?0:-1;return{pos:n.pos+i,start:n.pos,depth:n.depth,node:r}}return(0,o.qv)(n,j)}},R=function(t,e){var n=e.getAnimationPositionsAbs(t,(0,s.gh)((0,a.bh)().getState())===c.q.SLIDE_VIEW).reduce(function(t,e){return Math.max(t,e)},0),o=t.doc.nodeAt(n),r=o&&n>0?o.nodeSize:0;return n+r},T=function(){return new r.Sy({key:v.$,state:{init:function(){return new M},apply:function(t,e,n,o){return e.apply(t,o)}},props:{decorations:function(t){var e=[],n=this.getState(t);if(!1===n.enabled)return i.EH.create(t.doc,e);var o=R(t,n);return t.doc.descendants(function(n,r,a,s){var c=t.doc.resolve(r),l=j(n)||I(n,c);return r<o&&l&&e.push(i.p.node(r,r+n.nodeSize,{class:D})),(0,p.G)(n)||(0,f.N5)(n)?e.push(i.p.node(r,r+n.nodeSize,{class:C})):I(n,c)?e.push(i.p.node(r,r+n.nodeSize,{class:O,style:"--animate-index: ".concat(s+1)})):j(n)&&(e.push(i.p.node(r,r+n.nodeSize,{class:E})),(0,d.pt)(n)&&e.push(i.p.node(r,r+n.nodeSize,{class:"animatable-on-load-accent"}))),!((0,u.KH)(n)&&c.depth>1||(0,p.E)(n))}),i.EH.create(t.doc,e)}}})}},51784:function(t,e,n){n.d(e,{$:function(){return o}});var o=new(n(27191)).H$("animation")},51180:function(t,e,n){n.d(e,{R:function(){return u},p:function(){return l}});var o=n(96412),r=n(13089),i=n(72338),a=n(27191),s=n(69180),c=new a.H$("yDocSize"),u=function(t){var e=c.getState(t.state);return e?e.getYDocSize():null},l=i.hj.create({name:"yDocSize",addProseMirrorPlugins:function(){var t=this.options.document;return[new a.Sy({key:c,state:{init:function(){return new d(t)},apply:function(t,e){return e}}})]}}),d=function(){function t(e){(0,o.Z)(this,t),this.ydoc=e}return(0,r.Z)(t,[{key:"getYDocSize",value:function(){return s.D$(this.ydoc).byteLength}}]),t}()},89814:function(t,e,n){n.d(e,{g:function(){return u},j:function(){return l}});var o=n(18149),r=n.n(o),i=n(2784),a=n(46358),s=n(62141),c=n(24336),u=function(t){var e=(0,a.CG)(s.k8,function(){return r().apply(void 0,arguments)});return(0,i.useMemo)(function(){return{enabled:!!(t&&e&&(0,c.Jg)(t,e)),pos:null==e?void 0:e.pos}},[t,e])},l=function(t){var e=(0,a.CG)(s.ks),n=(0,a.CG)(s.Vt,function(){return r().apply(void 0,arguments)});(0,i.useEffect)(function(){if(t&&e&&n){console.debug("[useScrollAndSpotlightSync] collaboratorBeingFollowed spotlight or scroll changed",JSON.stringify(n,null,2));var o=n.spotlight,r=n.scroll;t.commands.syncSpotlightAndScroll({spotlight:o,scroll:r,scrollOffset:100,isFollowing:!0})}},[t,e,n])}},91718:function(t,e,n){n.d(e,{$1:function(){return o.$1},jB:function(){return r.j}});var o=n(24336),r=n(89814)},36738:function(t,e,n){n.d(e,{Ge:function(){return nt},yE:function(){return E.y},fb:function(){return nn.f},R$:function(){return ne.R$},VK:function(){return ne.VK},yg:function(){return E.e},vL:function(){return ne.vL}});var o,r,i,a=n(52780);a.tk.prototype.updateState=function(t){this.docView&&this.updateStateInner(t,this.state.plugins!=t.plugins)};var s=n(12741),c=n(81333),u=n(76133),l=n(53738),d=n(27302),f=n(71354),p=n(420),h=n(91012),v=n(79522),m=n(44058),g=n(64652),y=n(2784),b=n(91760),w=n(69180),A=n(37914),k=n(23313),S=n(91354),P=n(8699),M=n(51180),D=n(10710),E=n(82477),C=n(72338),O=n(27191),j=n(46988),I=n(46358),x=n(60636),Z=n(34264);function R(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=Array(e);n<e;n++)o[n]=t[n];return o}var T=function(){var t=document.createElement("span");t.classList.add("collaboration-cursor__caret","streaming-cursor"),t.setAttribute("style","border-color: var(--chakra-colors-trueblue-100)");var e=document.createElement("div");return e.classList.add("collaboration-cursor__label","streaming-cursor__label"),e.setAttribute("style","background-color: var(--chakra-colors-trueblue-100); color: var(--chakra-colors-trueblue-400)"),t.insertBefore(e,null),t},_=C.hj.create({name:"aiGeneration",addOptions:function(){return{provider:null}},addStorage:function(){return{generationEnabled:!1}},onCreate:function(){var t=this.options.provider;t&&t.awareness&&t.awareness.on("change",function(){var e,n=!1,o=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return R(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if("Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return R(t,e)}}(t))){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}(t.awareness.getStates());try{for(o.s();!(e=o.n()).done;){var r=(0,c.Z)(e.value,2),i=r[0];r[1].isStreaming&&i!==t.awareness.clientID&&(n=!0)}}catch(t){o.e(t)}finally{o.f()}var a=(0,I.bh)();(0,j.nl)(a.getState())!==n&&a.dispatch((0,j.R4)(n))})},addCommands:function(){var t=this;return{setAIGenerationRunning:function(e){return function(){var n;return t.storage.generationEnabled=e,null===(n=t.options.provider)||void 0===n||n.awareness.setLocalStateField("isStreaming",e),!0}}}},addProseMirrorPlugins:function(){var t=this.storage;return[new O.Sy({key:new O.H$("aiGeneration"),props:{decorations:function(e){if(!t.generationEnabled)return a.EH.empty;var n=[],o=e.doc.content.size-2,r=(0,C.qv)(e.doc.resolve(o),Z.KH),i=r?(0,x.t)(e.doc.resolve(r.pos),-1):null;return i&&r&&(n.push(a.p.widget(i.from,T,{key:"sal",side:10})),n.push(a.p.node(r.pos,r.pos+r.node.nodeSize,{class:"ai-generate-streaming-card"}))),a.EH.create(e.doc,n)}}})]}}),B=n(47507),z=C.hj.create({name:"aiModifications",onCreate:function(){var t=this;this.options.document.on("afterAllTransactions",function(e){var n=B.i.getState(t.editor.view.state);n&&n.flushMoveInstructionQueue(t.editor.view.state)})},addProseMirrorPlugins:function(){return[new O.Sy({key:B.i,state:{init:function(){return new B.Y},apply:function(t,e,n,o){return e.apply(t,o)}}})]},addCommands:function(){return{setInteractionRange:function(t,e){return function(n){return n.tr.setMeta("aiModificationAction",{type:"setInteractionRange",rangeId:t,range:e}),!0}}}}}),N=n(44713),H=n(34676),L=n(95472),U=C.hj.create({name:"salExtension",addStorage:function(){return{salPanelOpen:!1}},addProseMirrorPlugins:function(){var t,e;return[(t=this.editor,e=this.storage,new O.Sy({props:{attributes:function(){return e.salPanelOpen?{class:"sal-active"}:{class:""}},decorations:function(n){var o=n.doc,r=n.selection;if(e.salPanelOpen){var i=r.from,s=r.to,c=[];return(0,L.Ru)(r.$from,Z.KH).forEach(function(t,e){c.push(a.p.node(t.pos,t.pos+t.node.nodeSize,{class:(0,H.cx)(0==e?"sal-active-card":"sal-active-card-parent")}))}),(0,L.KB)(t)||(r instanceof O.Bs?c.push(a.p.inline(i,s,{class:(0,H.cx)("sal-selection-text")})):r instanceof O.qv&&c.push(a.p.node(i,s,{class:(0,H.cx)("sal-selection-node")}))),a.EH.create(o,c)}}}}))]},addCommands:function(){var t=this;return{setSalOpen:function(e){return function(n){return n.state,n.dispatch,t.storage.salPanelOpen=e,!0}}}}}),V=n(57461),q=n(95235),$=n(38564),F=n(54073),K=n.n(F),G=n(26151),Q=n(98875),Y=n(96412),W=n(13089),J=n(41701),X=n(90129),tt=n(29017),te=n(48200),tn=n(71657);function to(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=Array(e);n<e;n++)o[n]=t[n];return o}i=Symbol.iterator;var tr=function(t){(0,X.Z)(o,t);var e,n=(e=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}(),function(){var t,n=(0,te.Z)(o);if(e){var r=(0,te.Z)(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return(0,tt.Z)(this,t)});function o(t){(0,Y.Z)(this,o),e=n.call(this),(0,q.Z)((0,J.Z)(e),"yarray",void 0),e.yarray=t,e.doc=t.doc,e.map=new Map;var e,r=t.toArray();return e.doc.transact(function(n){for(var o=r.length-1;o>=0;o--){var i=r[o];e.map.has(i.key)?t.delete(o):e.map.set(i.key,i)}}),t.observe(function(n){var o=new Map,r=Array.from(n.changes.added);n.changes.deleted.forEach(function(t){t.content.getContent().forEach(function(t){e.map.get(t.key)===t&&(e.map.delete(t.key),o.set(t.key,{action:"delete",oldValue:t.val}))})});var i=new Map;r.map(function(t){return t.content.getContent()}).flat().forEach(function(t){i.set(t.key,t)});var a=new Set,s=t.toArray();e.doc.transact(function(n){for(var r=s.length-1;r>=0&&(i.size>0||a.size>0);r--){var c=s[r];if(a.has(c.key))a.delete(c.key),t.delete(r,1);else if(i.get(c.key)===c){var u=e.map.get(c.key);if(u)a.add(c.key),o.set(c.key,{action:"update",oldValue:u.val,newValue:c.val});else{var l=o.get(c.key);l&&"delete"===l.action?o.set(c.key,{action:"update",newValue:c.val,oldValue:l.oldValue}):o.set(c.key,{action:"add",newValue:c.val})}i.delete(c.key),e.map.set(c.key,c)}else i.has(c.key)&&(a.add(c.key),i.delete(c.key))}}),o.size>0&&e.emit("change",[o])}),e}return(0,W.Z)(o,[{key:i,value:function(){return this.yarray[Symbol.iterator]()}},{key:"values",value:function(){var t=this.yarray.length,e=-1;return(0,q.Z)({},Symbol.iterator,function(){return{next:function(){return++e===t?{value:void 0,done:!0}:{value:this.yarray.get(e),done:!1}}}})}},{key:"forEach",value:function(t){return this.yarray.forEach(t)}},{key:"set",value:function(t,e){var n=this;return this.doc.transact(function(o){n.map.has(t)&&n.delete(t),n.yarray.push([{key:t,val:e}])}),e}},{key:"delete",value:function(t){var e,n=0,o=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return to(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if("Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return to(t,e)}}(t))){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}(this.yarray);try{for(o.s();!(e=o.n()).done;){if(e.value.key===t){this.yarray.delete(n);break}n++}}catch(t){o.e(t)}finally{o.f()}}},{key:"get",value:function(t){var e=this.map.get(t);return e&&e.val}},{key:"has",value:function(t){return this.map.has(t)}}]),o}(tn.y);function ti(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=Array(e);n<e;n++)o[n]=t[n];return o}var ta=function(t){(0,X.Z)(o,t);var e,n=(e=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}(),function(){var t,n=(0,te.Z)(o);if(e){var r=(0,te.Z)(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return(0,tt.Z)(this,t)});function o(){var t;(0,Y.Z)(this,o);for(var e=arguments.length,r=Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r)),(0,q.Z)((0,J.Z)(t),"name","AnnotationsYKeyValue"),t}return(0,W.Z)(o,[{key:"createKeyValue",value:function(t,e){var n=t.getArray(e);return new tr(n)}},{key:"getRestoreMap",value:function(t){return t.getMap("annotationsAbsolute")}},{key:"run",value:function(t){var e,n=this.createKeyValue(t,"annotationsAbsoluteKV"),o=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return ti(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if("Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ti(t,e)}}(t))){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}(this.getRestoreMap(t).entries());try{for(o.s();!(e=o.n()).done;){var r=(0,c.Z)(e.value,2),i=r[0],a=r[1];n.set(i,a)}}catch(t){o.e(t)}finally{o.f()}}}]),o}(function(){function t(){(0,Y.Z)(this,t),(0,q.Z)(this,"name",void 0)}return(0,W.Z)(t,[{key:"run",value:function(t){}}]),t}());function ts(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=Array(e);n<e;n++)o[n]=t[n];return o}var tc=function(){function t(e){var n=this;(0,Y.Z)(this,t),(0,q.Z)(this,"document",void 0),(0,q.Z)(this,"migrations",[new ta]),(0,q.Z)(this,"annotations",void 0),(0,q.Z)(this,"annotationsAbsolute",void 0),this.document=e,this.document.transact(function(){n.runMigrations()}),this.annotations=this.document.getMap("annotations"),this.annotationsAbsolute=new tr(this.document.getArray("annotationsAbsoluteKV"))}return(0,W.Z)(t,[{key:"runMigrations",value:function(){var t,e=this.getMigrationsMap(),n=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return ts(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if("Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ts(t,e)}}(t))){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}(this.migrations);try{for(n.s();!(t=n.n()).done;){var o=t.value;if(!this.hasRunMigration(o.name))try{o.run(this.document),e.set(o.name,!0)}catch(t){}}}catch(t){n.e(t)}finally{n.f()}}},{key:"getMigrationsMap",value:function(){return this.document.getMap(t.ANNOTATION_MIGRATIONS_KEY)}},{key:"hasRunMigration",value:function(t){return this.getMigrationsMap().get(t)||!1}}]),t}();(0,q.Z)(tc,"ANNOTATION_MIGRATIONS_KEY","annotationMigrations");var tu=function(){function t(e){(0,Y.Z)(this,t),(0,q.Z)(this,"decoration",void 0),this.decoration=e}return(0,W.Z)(t,[{key:"id",get:function(){return this.decoration.type.spec.id}},{key:"from",get:function(){return this.decoration.from}},{key:"data",get:function(){return this.decoration.type.spec.data}},{key:"HTMLAttributes",get:function(){return this.decoration.type.attrs}},{key:"toString",value:function(){return JSON.stringify({id:this.id,data:this.data,from:this.from,HTMLAttributes:this.HTMLAttributes})}}]),t}(),tl=n(10221),td=n(84636),tf=n.n(td),tp=n(35838),th=n.n(tp),tv=n(9850),tm=n.n(tv),tg=n(36069),ty=n(39428),tb=n(39875);function tw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function tA(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tw(Object(n),!0).forEach(function(e){(0,q.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tw(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function tk(t){for(var e=[],n=t.length-1;n>=0;n--){var o=t[n];e.push(tA(tA({},o),{},{prev:o.next,next:o.prev}))}return e}var tS=function(){function t(e){(0,Y.Z)(this,t),this.map=e,(0,q.Z)(this,"undoQueue",[])}return(0,W.Z)(t,[{key:"flushUndoQueue",value:function(){var t=this.undoQueue;return this.undoQueue=[],t}},{key:"set",value:function(t,e){var n=this.map.get(t);return this.undoQueue.unshift({type:"set",key:t,next:n,prev:e}),this.map.set(t,e)}},{key:"delete",value:function(t){var e=this.map.get(t);return void 0===e||this.undoQueue.unshift({type:"set",key:t,next:e,prev:void 0}),this.map.delete(t)}}]),t}();function tP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function tM(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tP(Object(n),!0).forEach(function(e){(0,q.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tP(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function tD(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return tE(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if("Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return tE(t,e)}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var o=0,r=function(){};return{s:r,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:r}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function tE(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=Array(e);n<e;n++)o[n]=t[n];return o}var tC=function(){function t(e){(0,Y.Z)(this,t),this.options=e,(0,q.Z)(this,"decorations",a.EH.empty),(0,q.Z)(this,"annotations",[]),(0,q.Z)(this,"map",void 0),(0,q.Z)(this,"restoreMap",void 0),(0,q.Z)(this,"refreshDecorations",!1),(0,q.Z)(this,"hasChanges",!1),(0,q.Z)(this,"undoableMap",void 0),(0,q.Z)(this,"filmstripCutData",null),(0,q.Z)(this,"cutData",null),(0,q.Z)(this,"moveInstructionMap",{}),this.map=e.map,this.restoreMap=e.restoreMap,this.undoableMap=new tS(this.map)}return(0,W.Z)(t,[{key:"persistRestoreMap",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o={deletion:0,relToAbs:0,setting:0,total:0},r=performance.now();(n||this.hasChanges)&&(this.transactYDoc(function(){var n,r=performance.now(),i=tD(e.restoreMap);try{for(i.s();!(n=i.n()).done;){var a=n.value.key;e.restoreMap.delete(a)}}catch(t){i.e(t)}finally{i.f()}o.deletion=performance.now()-r,e.map.forEach(function(n){var r=n.id,i=n.pos,a=n.data;try{var s=performance.now(),c=e.relToAbs(t,i);o.relToAbs+=performance.now()-s;var u=performance.now();e.restoreMap.set(r,{id:r,data:a,absPos:c}),o.setting+=performance.now()-u}catch(t){console.error("[Annotations] persistRestoreMap error: ",t.message)}})}),o.total=performance.now()-r,this.log("[Annotations] persistRestoreMap in ".concat(o.total,"ms"),{values:this.restoreMap.yarray.toArray(),performance:o}),this.hasChanges=!1)}},{key:"flushMoveInstructionQueue",value:function(){var t=this.moveInstructionMap;return this.moveInstructionMap={},Object.values(t)}},{key:"clearCutData",value:function(){this.cutData=null,this.filmstripCutData=null}},{key:"getAnnotationsBetween",value:function(t,e,n){var o,r=[],i=tD(this.map.values());try{for(i.s();!(o=i.n()).done;){var a=o.value;try{var s=this.relToAbs(t,a.pos);if(null===s)continue;e<=s&&s<n&&r.push({id:a.id,data:a.data,pos:s,relativePos:a.pos})}catch(t){console.warn("[Annotations] getAnnotationsBetween error: ",t.message)}}}catch(t){i.e(t)}finally{i.f()}return r}},{key:"apply",value:function(t,e){if($.Gt.getState(e).isChangeOrigin){try{this.createDecorations(e)}catch(t){console.warn("[Annotations] handle remote change, not create decorations: ".concat(t.message))}return this}var n=t.getMeta(tl.Z);if(n){switch(n.type){case"addAnnotation":this.addAnnotation(n,e);break;case"restoreAnnotations":this.restoreAnnotations(n);break;case"clearAnnotations":this.clearAnnotations();break;case"deleteAnnotation":this.deleteAnnotation(n.id);break;case"refreshAnnotationDecorations":try{this.createDecorations(e)}catch(t){console.warn("could not create decorations: ".concat(t.message))}break;case"moveAnnotations":this.moveAnnotations(e,n.toMove)}return this.hasChanges=!0,this}switch(t.getMeta("uiEvent")){case"cut":this.handleCutTransaction(e,t);break;case"paste":this.handlePasteTransaction(e,t)}var o=t.getMeta("annotationEvent");switch(null==o?void 0:o.type){case"split-card":this.handleSplitCard(e,t,o);break;case"split-block":this.handleSplitBlock(e,t,o);break;case"join-forward":this.handleJoinForward(e,t,o);break;case"join-backward":this.handleJoinBackward(e,t,o);break;case"update-node-attrs":this.handleUpdateNodeAttrs(e,t,o);break;case"rearrange-cards":this.handleRearrangeCards(e,t,o);break;case"move":this.handleMove(e,t,o);break;case"merge-cards":this.handleMergeCards(e,t,o);break;case"drop":this.handleDropAnnotations(e,t,o);break;case"unwrap-node":this.handleUnwrapNode(e,t,o);break;case"wrap-nodes":this.handleWrapNodes(e,t,o);break;case"filmstrip-cut":this.handleFilmstripCut(e,t,o);break;case"filmstrip-paste":this.handleFilmstripPaste(e,t,o);break;default:t.getMeta("appendedTransaction")||(this.handleReplaceTransaction(e,t),this.handleReplaceAroundTransaction(e,t))}return t.docChanged&&(this.hasChanges=!0),this.handleLocalChange(t)}},{key:"restore",value:function(t,e){var n=this;e.forEach(function(e){var o=e.next,r=e.key;void 0===o?n.map.delete(r):n.map.set(r,tM(tM({},o),{},{pos:n.refreshRelativePos(t,o.pos)}))}),this.persistRestoreMap(t,!0)}},{key:"handleUnwrapNode",value:function(t,e,n){var o=this,r=n.pos,i=e.before.resolve(r),a=i.start(i.depth+1),s=e.before.resolve(a).end(),c=this.getAnnotationsBetween(t,a,s).map(function(e){var n=e.id,i=e.relativePos,s=o.relToAbs(t,i);return null===s?null:{id:n,newPos:r+(s-a)}}).filter(function(t){return!!t});this.log("%c[Annotations] unwrap node","color: green",{tr:e,pos:r,start:a,end:s,toMove:c}),c.length>0&&this.enqueueMoveInstructions(c)}},{key:"handleWrapNodes",value:function(t,e,n){var o=n.start,r=n.end,i=n.level,a=this.getAnnotationsBetween(t,o,r).map(function(t){return{id:t.id,newPos:t.pos+i}}).filter(function(t){return!!t});this.log("%c[Annotations] wrap nodes","color: green",{tr:e,start:o,end:r,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}},{key:"handleMergeCards",value:function(t,e,n){var o=n.insertPos,r=n.contentPos,i=e.before.nodeAt(r);if(!i){console.error("[AnnotationState] trying to merge cards, but cannot resolve content wrapper");return}var a=this.getAnnotationsBetween(t,r,r+i.nodeSize).map(function(t){return{id:t.id,newPos:o+(t.pos-r-1)}});this.log("%c[Annotations] merge cards","color: green",{transaction:e,insertPos:o,contentPos:r,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}},{key:"handleRearrangeCards",value:function(t,e,n){var o=this,r=n.rearrangedCardPositions,i=n.insertPos,a=r.flatMap(function(n){var r=n.newPos,i=n.oldPos,a=e.before.resolve(i);return o.getAnnotationsBetween(t,i,i+a.nodeAfter.nodeSize).map(function(t){return{id:t.id,newPos:r+(t.pos-i)}})}),c=[],u=(0,Z.Y0)(e.before);if(u){var l=r[0].oldPos,d=Math.min(l,i),f=Math.max(l,i);c=u.flatMap(function(n){var i=n.node,a=n.pos;if(!(a>=d&&a<=f&&!r.find(function(t){return t.id===i.attrs.id})))return[];var s=e.before.resolve(a),c=a+s.nodeAfter.nodeSize;return o.getAnnotationsBetween(t,a,c).map(function(t){var n=t.id,o=t.pos;return{id:n,newPos:e.mapping.map(o)}})})}this.log("%c[Annotations] rearrange cards","color: green",{transaction:e,rearrangedCardPositions:r,annotationsInRearrangedCards:a,jumpedAnnotations:c});var p=[].concat((0,s.Z)(a),(0,s.Z)(c));p.length>0&&this.enqueueMoveInstructions(p)}},{key:"handleMove",value:function(t,e,n){var o=n.insertPos,r=n.insertPosRaw,i=n.pos,a=n.end,c=this.getAnnotationsBetween(t,i,a).map(function(t){return{id:t.id,newPos:o+(t.pos-i)}}),u=this.getAnnotationsBetween(t,Math.min(r,a),Math.max(r,i)).map(function(t){var n=t.id,o=t.pos;return{id:n,newPos:e.mapping.map(o)}});this.log("%c[Annotations] move","color: green",{transaction:e,insertPos:o,insertPosRaw:r,pos:i,end:a,annotationsInCard:c,jumpedAnnotations:u});var l=[].concat((0,s.Z)(c),(0,s.Z)(u));l.length>0&&this.enqueueMoveInstructions(l)}},{key:"handleUpdateNodeAttrs",value:function(t,e,n){var o=n.pos,r=e.doc.nodeAt(o);if(r){var i=this.getAnnotationsBetween(t,o,o+r.nodeSize).map(function(t){return{id:t.id,newPos:t.pos}});this.log("%c[Annotations] update node attrs","color: green",{transaction:e,pos:o,toMove:i}),i.length>0&&this.enqueueMoveInstructions(i)}}},{key:"handleJoinBackward",value:function(t,e,n){var o=this,r=n.atBeginning,i=n.joinPos;if(r){var a=e.before.resolve(i),s=e.before.resolve(a.before()),c=s.nodeBefore,u=s.nodeAfter;if(c&&u){var l=s.pos+u.nodeSize,d=s.pos-c.nodeSize,f=t.selection.from;this.log("%c[Annotations] join backward","color: green",{transaction:e,prevBlock:c,nextBlock:u,nextBlockPos:s.pos,nextBlockEnd:l,prevBlockPos:d,joinPoint:f});var p=this.getAnnotationsBetween(t,s.pos,l);if(0===p.length){this.enqueueRefreshDecorations();return}0===u.content.size?(p.forEach(function(t){var e=t.id;return o.undoableMap.delete(e)}),requestAnimationFrame(function(){o.writeUndoStack(t)})):this.enqueueMoveInstructions(p.map(function(t){var e=t.id,n=Math.max(t.pos-s.pos-1,0);return{id:e,newPos:(0===c.content.size?d:f)+n}}))}}}},{key:"handleJoinForward",value:function(t,e,n){var o=this,r=n.atEnd,i=n.joinPos;if(r){var a=e.before.resolve(i),s=(0,L.nv)(a,function(t){return t.isBlock})[0],c=s.pos,u=s.node,l=e.before.resolve(a.after()),d=l.nodeAfter;if(d){var f=l.pos+d.nodeSize;this.log("%c[Annotations] join forward","color: green",{sel:t.selection,prevBlock:u,transaction:e,deleteAnnotations:!!d.isAtom,joinPos:a.pos,prevBlockPos:c,nextBlockPos:l.pos,nextBlock:d});var p=this.getAnnotationsBetween(t,c,c+u.nodeSize),h=this.getAnnotationsBetween(t,l.pos,f);if(0===h.length&&0===p.length){this.enqueueRefreshDecorations();return}var v=function(e){e.forEach(function(t){var e=t.id;return o.undoableMap.delete(e)}),requestAnimationFrame(function(){o.writeUndoStack(t)})};d.isAtom&&u.content.size>0?v(h):0===u.content.size?v(p):this.enqueueMoveInstructions(h.map(function(t){var e=t.id,n=Math.max(t.pos-l.pos-1,0);return{id:e,newPos:(0===u.content.size?c:i)+n}}))}}}},{key:"handleSplitBlock",value:function(t,e,n){var o=n.splitPos;if(n.atBeginning){this.enqueueRefreshDecorations();return}var r=e.before.resolve(o),i=(0,L.nv)(r,function(t){return t.isBlock})[0],a=i.pos,s=i.node,c=t.selection.$from,u=(0,L.nv)(c,function(t){return t.isBlock})[0],l=this.getAnnotationsBetween(t,o,a+s.nodeSize).map(function(t){var e=t.id,n=t.pos-o;return{id:e,newPos:u.pos+(0===n?n:n+1)}});l.length>0?this.enqueueMoveInstructions(l):this.enqueueRefreshDecorations(),this.log("%c[Annotations] split block","color: green",{sel:t.selection,transaction:e,splitPos:o,toMove:l,$before:r})}},{key:"handleSplitCard",value:function(t,e,n){var o=n.splitPos,r=e.before.resolve(o),i=(0,L.nv)(r,Z.KH)[0];if(i){var a=i.pos,s=i.pos+i.node.nodeSize,c=this.getAnnotationsBetween(t,a,s).map(function(t){var n=t.id,r=t.pos;return{id:n,newPos:r===o?e.mapping.map(r+1)-1:e.mapping.map(r)}});this.log("%c[Annotations] split card","color: green",{transaction:e,splitPos:o,parentEnd:s,toMove:c}),this.enqueueMoveInstructions(c)}}},{key:"handlePasteTransaction",value:function(t,e){if(this.cutData||this.filmstripCutData){var n=e.steps.find(function(t){return"replace"===t.jsonID});if(n){var o=n.from,r=n.to,i=n.slice.openStart,a=t.doc.resolve(n.from),s=r===o?o:o+1,c=null==a.nodeBefore&&a.parent.isBlock,u=!i||c;if(this.log("%c[Annotations] paste transaction","color: green",{transaction:e,insertPos:o,resolved:a,isPasteBeginning:c,pasteType:this.cutData?"cut":"filmstrip-cut"}),this.cutData){var l=this.cutData;this.cutData=null;var d=l.toMove.map(function(t){var e=t.id,n=t.offset;return{id:e,newPos:s+(u?n:Math.max(0,n))}});d&&d.length>0&&(this.log("[Annotations] paste from cut final move",d),this.enqueueMoveInstructions(d))}else if(this.filmstripCutData){var f=this.filmstripCutData;this.filmstripCutData=null;for(var p=s-1;p<t.doc.nodeSize;){var h=t.doc.nodeAt(p);if(h&&(0,Z.KH)(h))break;p++}var v=this.getMoveInstructionsForFilmstripPaste(e,f,p);v&&v.length>0&&(this.log("[Annotations] paste from filmstrip cut final move",v),this.enqueueMoveInstructions(v))}}}}},{key:"getMoveInstructionsForFilmstripPaste",value:function(t,e,n){if(e){var o=(0,C.N2)(t.doc,Z.KH);if(o){var r=t.doc.resolve(n).depth,i=o.filter(function(e){var n=e.pos;return t.doc.resolve(n).depth===r}),a=i.findIndex(function(t){return t.pos===n});if(-1!==a){var s=i.slice(a);return e.flatMap(function(t){var e=t.cardIndex;return t.annotations.map(function(t){var n=t.id,o=t.offset,r=s[e];if(r)return{id:n,newPos:r.pos+o}}).filter(function(t){return!!t})})}}}}},{key:"handleFilmstripPaste",value:function(t,e,n){if(this.cutData||this.filmstripCutData){var o=n.insertPos;if(this.cutData){var r=this.cutData;this.cutData=null;var i=r.toMove.map(function(t){return{id:t.id,newPos:o+t.offset}});i&&i.length>0&&(this.log("[Annotations] filmstripPaste from cut final move",{tr:e,cutData:r,moveInstructions:i}),this.enqueueMoveInstructions(i))}else if(this.filmstripCutData){var a=this.filmstripCutData;this.filmstripCutData=null;var s=this.getMoveInstructionsForFilmstripPaste(e,a,o);s&&s.length>0&&(this.log("%c[Annotations] filmstripPaste from filmstrip cut final move","color: green",{tr:e,filmstripCutData:a,moveInstructions:s}),this.enqueueMoveInstructions(s))}}}},{key:"handleFilmstripCut",value:function(t,e,n){var o=this;this.cutData=null,this.filmstripCutData=n.deleted.map(function(n){var r=n.cardIndex,i=n.pos,a=e.before.resolve(i),s=i+a.nodeAfter.nodeSize;return{cardIndex:r,annotations:o.getAnnotationsBetween(t,i,s).map(function(t){return{id:t.id,offset:t.pos-i}})}}),this.log("%c[Annotations] filmstripCut","color: green",{tr:e,filmstripCutData:this.filmstripCutData})}},{key:"handleCutTransaction",value:function(t,e){var n=this,o=e.steps.find(function(t){return"replace"===t.jsonID});if(o){this.filmstripCutData=null;var r=o.from,i=o.to,a=t.doc.resolve(r),s=null==a.nodeAfter&&null==a.nodeBefore&&a.parent.isBlock,c=this.getAnnotationsBetween(t,r-(s?1:0),i),u=c.map(function(e){var o=n.relToAbs(t,e.relativePos);return{id:e.id,offset:o-r}});this.cutData={slice:o.slice,toMove:u},this.log("%c[Annotations] cut transaction","color:green",{isWholeBlock:s,resolved:a,transaction:e,annotations:c,moveData:u})}}},{key:"handlePrependContentToBlock",value:function(t,e){var n=this,o=e.steps.find(function(t){return"replace"===t.jsonID});if(o){var r=o.from,i=e.before.resolve(r);if(i.nodeAfter){var a=this.getAnnotationsBetween(t,r,r+i.nodeAfter.nodeSize).map(function(o){var i=o.id,a=o.relativePos,s=n.relToAbs(t,a);return{id:i,newPos:s===r?e.mapping.map(s+1)-1:e.mapping.map(s)}});a.length>0&&(this.log("%c[Annotations] replace transaction - prepend content","color:green",{tr:e,annotationsToMove:a}),this.enqueueMoveInstructions(a))}}}},{key:"handleReplaceTransaction",value:function(t,e){var n=this,o=e.steps.find(function(t){return"replace"===t.jsonID});if(o){var r=o.from,i=o.to,a=e.before.resolve(r),c=e.before.resolve(i),u=a.parent!==c.parent,l=0==o.slice.content.size,d=0===a.parentOffset&&i>=r+a.parent.nodeSize-2,f=d&&l;if(0===c.parentOffset&&c.depth===a.depth+1&&c.pos-a.pos==1)return this.handlePrependContentToBlock(t,e);var p=!1;if(u){var h,v=f?[]:this.getAnnotationsBetween(t,r-a.parentOffset-1,r).map(function(e){var o=e.id,r=e.relativePos;return{id:o,newPos:n.relToAbs(t,r)}}),m=this.getAnnotationsBetween(t,i,i+(null===(h=c.nodeAfter)||void 0===h?void 0:h.nodeSize)+1).map(function(o){var r=o.id,i=o.relativePos;return{id:r,newPos:e.mapping.map(n.relToAbs(t,i))}}),g=[].concat((0,s.Z)(v),(0,s.Z)(m));this.log("[Annotations] multiline to move",g),g.length>0&&(p=!0,this.enqueueMoveInstructions(g))}var y=this.getAnnotationsBetween(t,r-(f||u&&0===a.parentOffset?1:0),i);y.length>0&&(p=!0,this.log("[Annotations] to delete",y),y.forEach(function(t){n.undoableMap.delete(t.id)})),p&&(this.log("%c[Annotations] replace transaction","color:green",{tr:e,annotationsToDelete:y,isWholeBlock:f,isMultiline:u,replacingEntireFromBlock:d,replacingWithNothing:l}),requestAnimationFrame(function(){n.writeUndoStack(t)}))}}},{key:"handleReplaceAroundTransaction",value:function(t,e){var n=this,o=th()(e.steps.filter(function(t){return"replaceAround"===t.jsonID}),function(e){var o=e.from,r=e.to;return n.getAnnotationsBetween(t,o,r)}),r=tf()(o,function(t){return t.id}).map(function(t){var n=t.id,o=t.pos;return{id:n,newPos:e.mapping.map(o)}});return r.length>0&&this.log("%c[Annotations] replaceAround transaction","color:green",{tr:e,moveInsturctions:r}),0!==r.length&&(this.enqueueMoveInstructions(r),!0)}},{key:"clearAnnotations",value:function(){var t=this;this.transactYDoc(function(){t.map.forEach(function(e,n){t.map.delete(n)})})}},{key:"restoreAnnotations",value:function(t){this.log("%c[Annotations] restoreAnnotations","color: green",t);var e=t.toRestore;this.clearAnnotations(),this.enqueueMoveInstructions(e.filter(function(t){return null!=t.absPos}).map(function(t){var e=t.absPos;return{id:t.id,newPos:e}}))}},{key:"addAnnotation",value:function(t,e){this.log("%c[Annotations] addAnnotation","color: green",t);var n=t.pos,o=t.id,r=t.data,i=this.absToRel(e,n);this.map.set(o,{id:o,pos:i,data:r})}},{key:"deleteAnnotation",value:function(t){this.log("%c[Annotations] deleteAnnotation","color: green",t),this.map.delete(t)}},{key:"moveAnnotations",value:function(t,e){var n=this,o=this.map;this.log("%c[Annotations] moveAnnotations","color: green",e),this.transactYDoc(function(){e.forEach(function(e){var r=e.id,i=e.newPos,a=o.get(r)||{id:r};n.undoableMap.set(r,tM(tM({},a),{},{pos:n.absToRel(t,i)}))})}),this.writeUndoStack(t)}},{key:"writeUndoStack",value:function(t){var e=$.Gk.getState(t).undoManager;if(0!==e.undoStack.length){var n=this.undoableMap.flushUndoQueue();if(0!==n.length){var o=e.undoStack[e.undoStack.length-1],r="annotations",i=o.meta.get(r)||[];i.length>0&&this.log("[Annotations] existing undo stack",{existing:i,toWrite:n,stack:e.undoStack});var a=[].concat((0,s.Z)(n),(0,s.Z)(i));o.meta.set(r,a),this.log("[Annotations] writing to undo stack",a)}}}},{key:"createDecorations",value:function(t){var e=this.options.map;this.refreshDecorations=!1;var n=[],o=[];e.forEach(function(e,r){var i=(0,ty.XV)(t,e.pos);if(null!=i){var s=t.doc.nodeAt(i);s&&(null!=s&&s.isInline?n.push(a.p.inline(i,i+1,{class:"debug-comment-cursor"})):n.push(a.p.node(i,i+s.nodeSize,{class:"debug-comment-block"}))),o.push({id:r,data:e.data,relativePos:e.pos,pos:i})}}),t.doc.descendants(function(t,e,r){return!!(!(e>0)||(0,tb.ZM)(r)||(0,tb.ZM)(t))&&(o.filter(function(n){return n.pos>=e&&n.pos<e+t.nodeSize}).forEach(function(o){var r=o.id,i=o.data;n.push(a.p.node(e,e+t.nodeSize,{},{isAnnotation:!0,id:r,data:i}))}),!0)}),this.decorations=a.EH.create(t.doc,n),this.annotations=o}},{key:"handleDropAnnotations",value:function(t,e,n){var o=n.dragging,r=o.origNodePos,i=o.inBlock,a=o.inCard,s=n.droppedBlockPos,c=[];i.forEach(function(t){var e=s+(t.pos-r);c.push({id:t.id,newPos:e})}),this.getAnnotationsBetween(t,s,s+1).filter(function(t){return!c.find(function(e){return e.id===t.id})}).forEach(function(t){c.push({id:t.id,newPos:e.mapping.map(t.pos)})}),a.filter(function(t){return!c.find(function(e){return e.id===t.id})}).forEach(function(t){var n=e.mapping.map(t.pos);c.push({newPos:n,id:t.id})}),this.log("%c[Annotations] handleDropAnnotations","color: green",{action:n,tr:e,toMove:c}),c.length>0&&this.enqueueMoveInstructions(c)}},{key:"handleLocalChange",value:function(t){var e=this,n=(0,s.Z)(this.decorations.find(void 0,void 0,function(t){return t.isAnnotation&&e.moveInstructionMap[t.id]})),o=this.decorations.remove(tm()(n)).map(t.mapping,t.doc).add(t.doc,n);return this.decorations=o,this}},{key:"absToRel",value:function(t,e){var n=(0,ty.jS)(t,e);if(!n)throw Error("Y.State non initialized");return n}},{key:"relToAbs",value:function(t,e){return(0,ty.XV)(t,e)}},{key:"refreshRelativePos",value:function(t,e){var n=$.Gt.getState(t),o=n.doc,r=n.type,i=n.binding,a=(0,tg.SF)(o,r,e,i.mapping);return(0,tg.JR)(a,r,i.mapping)}},{key:"enqueueMoveInstructions",value:function(t){var e=this;t.forEach(function(t){e.moveInstructionMap[t.id]&&console.error("[AnnotationState] trying to enqueue two move instructions for annotation with targetId=".concat(t.id)),e.moveInstructionMap[t.id]=t})}},{key:"enqueueRefreshDecorations",value:function(){this.refreshDecorations=!0}},{key:"transactYDoc",value:function(t){this.options.document.transact(t)}},{key:"log",value:function(){var t,e;Q.VH.get("debugComments")?(t=console).log.apply(t,arguments):(e=console).debug.apply(e,arguments)}}]),t}(),tO=function(t){var e=K()(function(t){tl.Z.getState(t.state).persistRestoreMap(t.state)},500);return new O.Sy({key:tl.Z,state:{init:function(){return new tC(t)},apply:function(t,e,n,o){return e.apply(t,o)}},view:function(){return{update:function(t){e(t)}}},props:{transformPasted:function(e){var n,o=this.getState(t.editor.state),r=null===(n=e.content.firstChild)||void 0===n?void 0:n.attrs.docId;return r&&r!==t.editor.gammaDocId&&o.clearCutData(),e},handleDOMEvents:{copy:function(t){return this.getState(t.state).clearCutData(),!1}},decorations:function(e){var n=this.getState(e),o=n.decorations,r=n.annotations;return t.onUpdate&&t.onUpdate(o.find().map(function(t){return new tu(t)}),r),o}}})};function tj(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function tI(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tj(Object(n),!0).forEach(function(e){(0,q.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tj(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var tx=C.hj.create({name:"annotation",onCreate:function(){var t=this,e=function(){var t,e;Q.VH.get("debugComments")?(t=console).log.apply(t,arguments):(e=console).debug.apply(e,arguments)};this.options.document.on("afterAllTransactions",function(n){var o=tl.Z.getState(t.editor.view.state),r=o.flushMoveInstructionQueue();r.length>0?(e("%c[Annotations] afterAllTransactions handling queued moves","color:pink",r),t.editor.commands.moveAnnotations(r)):o.refreshDecorations&&(e("%c[Annotations] afterAllTransactions refreshDecorations","color:pink"),t.editor.commands.refreshDecorations())});var n=tl.Z.getState(this.editor.state);window.gammaAnnotations=n;var o=$.Gk.getState(this.editor.state).undoManager;setTimeout(function(){o.on("stack-item-popped",function(e){var r=e.stackItem.meta.get("annotations");if(!r){n.persistRestoreMap(t.editor.state,!0);return}var i=o.undoStack,a=o.redoStack;"undo"===e.type&&a.length>0?a[a.length-1].meta.set("annotations",tk(r)):"redo"===e.type&&i.length>0&&i[i.length-1].meta.set("annotations",tk(r)),n.restore(t.editor.state,r)})},0),n.map.observe(K()(function(){e("[Annotations] map observe -> resfreshDecorations"),t.editor.commands.refreshDecorations()})),this.editor.commands.refreshDecorations()},addCommands:function(){return{restoreAnnotations:function(t){return function(e){var n=e.dispatch,o=e.tr;return n&&(o.setMeta(tl.Z,{type:"restoreAnnotations",toRestore:Object.values(t)}),n(o)),!0}},updateAttributes:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(n){var o,r,i=n.tr,a=n.state,s=n.dispatch,c=null,u=null,l=(o="string"==typeof t?t:t.name,(r=a.schema).nodes[o]?"node":r.marks[o]?"mark":null);return!!l&&("node"===l&&(c=(0,C.jo)(t,a.schema)),"mark"===l&&(u=(0,C.TP)(t,a.schema)),s&&i.selection.ranges.forEach(function(t){var n=t.$from.pos,o=t.$to.pos;a.doc.nodesBetween(n,o,function(t,r){c&&c===t.type&&i.setNodeMarkup(r,void 0,tI(tI({},t.attrs),e)).setMeta("annotationEvent",{type:"update-node-attrs",pos:r}),u&&t.marks.length&&t.marks.forEach(function(a){if(u===a.type){var s=Math.max(r,n),c=Math.min(r+t.nodeSize,o);i.addMark(s,c,u.create(tI(tI({},a.attrs),e)))}})})}),!0)}},wrapWithAnnotations:function(t,e){return function(n){var o=n.state,r=n.tr,i=n.dispatch,a=o.schema.nodes[t],s=o.selection,c=s.$from,u=s.$to,l=c.blockRange(u),d=l&&(0,G.nd)(l,a,e);if(!d||!l)return!1;var f=l.start,p=l.end;return!i||(r.wrap(l,d).setMeta("annotationEvent",{type:"wrap-nodes",start:f,end:p,level:1}).scrollIntoView(),!0)}},moveAnnotations:function(t){return function(e){var n=e.dispatch,o=e.tr;return n&&(o.setMeta(tl.Z,{type:"moveAnnotations",toMove:t}),n(o)),!0}},clearAnnotations:function(){return function(t){var e=t.dispatch,n=t.tr;return e&&(n.setMeta(tl.Z,{type:"clearAnnotations"}),e(n)),!0}},refreshDecorations:function(){return function(t){var e=t.dispatch,n=t.tr;return e&&(n.setMeta(tl.Z,{type:"refreshAnnotationDecorations"}),e(n)),!0}},addAnnotation:function(t){var e=t.pos,n=t.id,o=t.data;return function(t){var r=t.dispatch,i=t.state;return r&&i.tr.setMeta(tl.Z,{type:"addAnnotation",id:n,data:o,pos:e}),!0}},deleteAnnotation:function(t){return function(e){var n=e.dispatch,o=e.state;return n&&o.tr.setMeta(tl.Z,{type:"deleteAnnotation",id:t}),!0}}}},addProseMirrorPlugins:function(){var t=this.options,e=t.document,n=t.onUpdate,o=new tc(e);return[tO({document:e,editor:this.editor,map:o.annotations,restoreMap:o.annotationsAbsolute,onUpdate:n})]}}),tZ=n(52527),tR=C.hj.create({name:"draftComments",addCommands:function(){return{removeDraftComments:function(t){return function(e){var n=e.dispatch,o=e.tr;if(n){var r={type:"removeDraftComment",comments:Array.isArray(t)?t:[t]};o.setMeta(tZ.N,r),n(o)}return!0}},createDraftComment:function(t){return function(e){var n=e.dispatch,o=e.tr;return n&&(o.setMeta(tZ.N,{type:"createDraftComment",comment:t}),n(o)),!0}}}},addProseMirrorPlugins:function(){return[(0,tZ.O)()]}}),tT=n(9734),t_=new O.H$("mobileAnnotationPluginKey"),tB=function(){function t(){(0,Y.Z)(this,t),(0,q.Z)(this,"pos",null),(0,q.Z)(this,"timeout",void 0)}return(0,W.Z)(t,[{key:"apply",value:function(t,e){var n=t.getMeta(t_);return n&&"setPos"in n&&(this.pos=n.setPos),this}}]),t}(),tz=C.hj.create({name:"mobileAnnotation",addCommands:function(){return{setMobileAddBlockComment:function(t){return function(e){var n=e.dispatch,o=e.tr,r=e.view;if(!n)return!1;if(null===t)return o.setMeta(t_,{setPos:null}),n(o),!0;var i=t.clientX,a=t.clientY,s=r.posAtCoords({left:i,top:a});if(null===s)return!0;var c=(0,tb.f$)(s.inside,r);if(!c)return!1;var u=r.coordsAtPos(c.pos),l=i-u.left,d=a-u.top;return o.setMeta(t_,{setPos:{pos:c.pos,end:c.end,offsetX:l,offsetY:d}}),n(o),!0}}}},addProseMirrorPlugins:function(){var t;return[(t=this.editor,new O.Sy({key:t_,state:{init:function(){return new tB},apply:function(t,e,n,o){return e.apply(t,o)}},props:{handleDOMEvents:{click:function(e,n){if(!(0,tT.s2)())return!1;if(!n.target.closest("[data-comments-wrapper]")){var o=t_.getState(e.state);o.pos||(o.timeout?(clearTimeout(o.timeout),o.timeout=null,t.commands.setMobileAddBlockComment(n)):o.timeout=setTimeout(function(){o.timeout=null},300))}}},decorations:function(t){var e=t_.getState(t).pos;if(null===e)return a.EH.empty;var n=a.p.node(e.pos,e.end,{},{isMobileAnnotation:!0,type:"show-buttons",offsetX:e.offsetX,offsetY:e.offsetY});return a.EH.create(t.doc,[n])}}}))]}}),tN=n(99638),tH=C.hj.create({name:"BlockHover",addProseMirrorPlugins:function(){return[(0,tN.RT)(this.editor)]}}),tL=n(41962),tU=n(56143),tV=n(47684),tq=n(66902),t$=C.hj.create({name:"collaboration",priority:tq.a.Collaboration,addOptions:function(){return{document:null,field:"default",fragment:null}},onCreate:function(){this.editor.extensionManager.extensions.find(function(t){return"history"===t.name})&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-history".')},addCommands:function(){return{undo:function(){return function(t){var e=t.tr,n=t.state,o=t.dispatch;return e.setMeta("preventDispatch",!0),0!==$.Gk.getState(n).undoManager.undoStack.length&&(!o||(0,tU.Yw)(n)||!0)}},redo:function(){return function(t){var e=t.tr,n=t.state,o=t.dispatch;return e.setMeta("preventDispatch",!0),0!==$.Gk.getState(n).undoManager.redoStack.length&&(!o||(0,tU.KX)(n)||!0)}}}},addKeyboardShortcuts:function(){var t=this;return{"Mod-z":function(){return t.editor.commands.undo()},"Mod-y":function(){return t.editor.commands.redo()},"Shift-Mod-z":function(){return t.editor.commands.redo()}}},addProseMirrorPlugins:function(){var t=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field);return[(0,tV.Z)(t),(0,tU.v0)(),new O.Sy({appendTransaction:function(t,e,n){if(t.some(function(t){return!1==t.getMeta("addToHistory")})){var o=n.tr;return o.setMeta("addToHistory",!1),o}return null}})]}}),tF=n(67702),tK=n(98537),tG=n.n(tK),tQ=n(98621),tY=n.n(tQ);function tW(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}var tJ=function(){return null},tX=function(t){return Array.from(t.entries()).map(function(t){var e=(0,c.Z)(t,2);return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?tW(Object(n),!0).forEach(function(e){(0,q.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):tW(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({clientId:e[0]},e[1].user)})},t0=C.hj.create({name:"collaborationCursor",addOptions:function(){return{provider:null,user:{name:null,color:null},render:function(t){var e=document.createElement("span");if(!t.isReady)return e;e.classList.add("collaboration-cursor__caret"),e.setAttribute("style","border-color: ".concat(t.color));var n=document.createElement("div");n.classList.add("collaboration-cursor__label"),n.setAttribute("style","background-color: ".concat(t.color,"; color: ").concat(tY()(t.color).isDark()?"white":"black"));var o=t.name.split(" ")[0];return n.insertBefore(document.createTextNode(o),null),e.insertBefore(n,null),e},onUpdate:tJ}},addStorage:function(){return{users:[]}},addCommands:function(){var t=this;return{user:function(e){return function(){return t.options.user=tG()({},t.options.user,e),t.options.provider.awareness.setLocalStateField("user",t.options.user),!0}}}},addProseMirrorPlugins:function(){var t=this;return[(0,tF.JL)((t.options.provider.awareness.setLocalStateField("user",t.options.user),t.storage.users=tX(t.options.provider.awareness.states),t.options.provider.awareness.on("update",function(){t.storage.users=tX(t.options.provider.awareness.states)}),t.options.provider.awareness),{cursorBuilder:this.options.render})]}}),t1=n(17945),t2=C.hj.create({name:"globalDragHandle",priority:tq.a.GlobalDragHandle,addOptions:function(){return{scrollerSelector:"body"}},addStorage:function(){return{enabled:!0}},addProseMirrorPlugins:function(){return[(0,t1.f)({editor:this.editor,storage:this.storage,scrollerSelector:this.options.scrollerSelector})]},extendNodeSchema:function(t){var e;return{containerHandle:null!==(e=(0,C.nU)((0,C.Nl)(t,"containerHandle",t)))&&void 0!==e&&e}}}),t3=n(52347),t8=n(99703),t4=n(38815),t5=C.hj.create({name:"filmstrip",onCreate:function(){var t=$.Gk.getState(this.editor.state).undoManager;t.on("stack-item-popped",function(e){var n=t.undoStack,o=t.redoStack,r=e.stackItem.meta.get("filmstripState");if(r){var i=(0,t4.sy)((0,I.bh)().getState());"undo"===e.type&&o.length>0?o[o.length-1].meta.set("filmstripState",i):"redo"===e.type&&n.length>0&&n[n.length-1].meta.set("filmstripState",i),(0,I.bh)().dispatch((0,t4.tE)(r))}})}}),t9=n(82114),t7=n(80591),t6=n(95158),et=n(74418),ee=C.hj.create({name:"scrollMargin",addProseMirrorPlugins:function(){return[new O.Sy({props:{scrollMargin:et.Sf,scrollThreshold:et.Sf}})]}}),en=n(11723),eo=n(92397),er=n(91718),ei=n(95173),ea=n(94301),es=n(11919),ec=n(4036),eu=n(65903),el=n.n(eu),ed=n(59131),ef=n(52322),ep=function(t){var e=t.editor,n=(0,y.useState)(null),o=n[0],r=n[1];(0,y.useEffect)(function(){if(e){var t=function(){r(e.state.selection)};return t(),e.on("selectionUpdate",t),function(){e.off("selectionUpdate",t)}}},[e]);var i=o instanceof O.qv,a=o instanceof ed.c,s=el()((null==o?void 0:o.toJSON().type)||"none"),c=el()(i&&(null==o?void 0:o.node.type.name)||""),u=a?void 0:i?"blue":"green";return(0,ef.jsx)(ea.h,{children:(0,ef.jsx)(es.k,{className:"selection-debugger",position:"absolute",top:"50px",left:"10px",zIndex:"999999",children:(0,ef.jsxs)(f.K,{direction:"column",children:[(0,ef.jsxs)(ec.C,{colorScheme:u,children:[s,c&&(0,ef.jsxs)("i",{children:[" (",c,")"]})]}),o&&(0,ef.jsxs)(ec.C,{colorScheme:"gray",children:["f:",o.from," - t:",o.to,a&&" | side:".concat(o.side)]})]})})})},eh=n(37164),ev=n(43997),em=n(71672),eg=n(49392),ey=n(62141),eb=(0,eh.kP)("1234567890",10),ew=function(){var t=em.Q.getItem(eg.H.sessionId);if(t)return t;var e="".concat(+new Date,"__").concat(eb());return em.Q.setItem(eg.H.sessionId,e),e},eA=function(t,e){var n=(0,D.SE)(),o=n.user,r=n.isUserLoading,i=n.anonymousUser,a=n.color,s=(0,y.useRef)(!1),c=(0,ev.I0)(),u=(0,y.useMemo)(function(){return ew()},[]),l=(0,y.useMemo)(function(){return{id:(null==o?void 0:o.id)||i.id,color:a.value,sessionId:u,idleSince:null,name:(null==o?void 0:o.displayName)||i.displayName||"",profileImageUrl:(null==o?void 0:o.profileImageUrl)||"",isReady:!r,spotlight:{pos:null,cardId:null}}},[o,a,r,i,u]);(0,y.useEffect)(function(){if(t&&!t.isDestroyed&&e){t.commands.user(l),!s.current&&l.isReady&&(t.chain().blur().focusDelayed().run(),s.current=!0),c((0,ey.MU)({sessionId:l.sessionId}));var n=function(t,n){t.added,t.updated,t.removed,requestIdleCallback(function(){var t=tX(e.awareness.states);c((0,ey.Tx)({collaborators:t}))},{timeout:500})};e.awareness.on("change",n);var o=K()(n,ey.Jp);return e.awareness.on("update",o),function(){e.awareness.off("change",n),e.awareness.off("update",o)}}},[l,t,e,c]),(0,y.useEffect)(function(){if(t){var e=K()(function(e){t.commands.user(e)},10);return(0,I.tC)(ey.gL,e)}},[t])},ek=n(68015),eS=n.n(ek),eP=function(t){var e=(0,y.useState)([]),n=e[0],o=e[1];return{logMessages:n,logPerfMessage:(0,y.useCallback)(function(e){if(t){var n=performance.now(),r={msg:e,timestamp:n};o(function(t){return 0===t.length?[].concat((0,s.Z)(t),[r]):t.find(function(t){return t.msg===e})||t[t.length-1].msg===e?t:(r.duration=eS()(n-t[t.length-1].timestamp,2),[].concat((0,s.Z)(t),[r]))})}},[t]),dumpLog:(0,y.useCallback)(function(){t&&o(function(t){try{console.table(t)}catch(t){}return[]})},[t])}},eM=n(21755),eD=n(81617),eE="custom",eC="updates",eO=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=eD.ay(t.db,[eC]),o=(0,c.Z)(n,1)[0];return eD.go(o,eD.sc(t._dbref,!1)).then(function(n){e(o),w.ay(t.doc,function(){n.forEach(function(e){return w.NG(t.doc,e)})},t,!1)}).then(function(){return eD.S_(o).then(function(e){t._dbref=e+1})}).then(function(){return eD.QX(o).then(function(e){t._dbsize=e})}).then(function(){return o})},ej=function(t){var e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return eO(t).then(function(n){(e||t._dbsize>=500)&&eD.yP(n,w.D$(t.doc)).then(function(){return eD.IV(n,eD.UE(t._dbref,!0))}).then(function(){return eD.QX(n).then(function(e){t._dbsize=e})})})},eI=function(t){(0,X.Z)(o,t);var e,n=(e=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}(),function(){var t,n=(0,te.Z)(o);if(e){var r=(0,te.Z)(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return(0,tt.Z)(this,t)});function o(t,e){var r;return(0,Y.Z)(this,o),(r=n.call(this)).doc=e,r.name=t,r._dbref=0,r._dbsize=0,r._destroyed=!1,r.db=null,r.synced=!1,r._db=eD.X3(t,function(t){return eD._w(t,[["updates",{autoIncrement:!0}],["custom"]])}),r.whenSynced=r._db.then(function(t){return r.db=t,eO((0,J.Z)(r),function(t){return eD.yP(t,w.D$(e))}).then(function(){return r._destroyed||(r.emit("synced",[(0,J.Z)(r)]),r.synced=!0),(0,J.Z)(r)})}),r._storeTimeout=1e3,r._storeTimeoutId=null,r._storeUpdate=function(t,e){if(r.db&&e!==(0,J.Z)(r)){var n=eD.ay(r.db,[eC]),o=(0,c.Z)(n,1)[0];eD.yP(o,t),++r._dbsize>=500&&(null!==r._storeTimeoutId&&clearTimeout(r._storeTimeoutId),r._storeTimeoutId=setTimeout(function(){ej((0,J.Z)(r),!1),r._storeTimeoutId=null},r._storeTimeout))}},e.on("update",r._storeUpdate),r.destroy=r.destroy.bind((0,J.Z)(r)),e.on("destroy",r.destroy),r}return(0,W.Z)(o,[{key:"destroy",value:function(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(function(t){t.close()})}},{key:"clearData",value:function(){var t=this;return this.destroy().then(function(){eD.Lj(t.name)})}},{key:"get",value:function(t){return this._db.then(function(e){var n=eD.ay(e,[eE],"readonly"),o=(0,c.Z)(n,1)[0];return eD.U2(o,t)})}},{key:"set",value:function(t,e){return this._db.then(function(n){var o=eD.ay(n,[eE]),r=(0,c.Z)(o,1)[0];return eD.gz(r,e,t)})}},{key:"del",value:function(t){return this._db.then(function(e){var n=eD.ay(e,[eE]),o=(0,c.Z)(n,1)[0];return eD.IV(o,t)})}}]),o}(tn.y),ex=function(t,e,n){var o=new eI(t,e),r=K()(function(){var t=e.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION");o.set("lastUpdated",new Date().toISOString()),o.set("schemaVersion",t||"")},1e3);return e.on("update",r),o.on("synced",function(){null==n||n()}),o},eZ=n(56574),eR=n(93665),eT=n(55452),e_=n(40110),eB=n(55479),ez=n(49929),eN=n(8388),eH=n(32333),eL=n(21819),eU=n(20406),eV=n(28526),eq=n.n(eV);n(18149);var e$=(o=(0,eU.Z)(eq().mark(function t(e,n,o,r){var i,a,s,c,u;return eq().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=(i=o||{}).id,s=i.length,t.next=4,fetch("".concat(A.v.MULTIPLAYER_WS_URL.replace("wss","https"),"/").concat(e,"/verify/").concat(n),{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({id:a,length:s,clientCount:null==r?void 0:r.clientCount,totalCount:null==r?void 0:r.totalCount})});case 4:return c=t.sent,t.next=7,c.json();case 7:return u=t.sent,t.abrupt("return",u);case 11:t.prev=11,t.t0=t.catch(0);case 13:return t.abrupt("return");case 14:case"end":return t.stop()}},t,null,[[0,11]])})),function(t,e,n,r){return o.apply(this,arguments)}),eF=function(t){var e=t.document.store.clients.get(t.document.clientID);if(e&&e.length)return e[e.length-1]},eK=(r=(0,eU.Z)(eq().mark(function t(e,n,o){var r,i,a,c,u,l,d;return eq().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=eF(n),i={clientCount:n.document.store.clients.size,totalCount:(0,s.Z)(n.document.store.clients.values()).reduce(function(t,e){return t+e.reduce(function(t,e){return t+e.length},0)},0)},t.next=4,e$(e.gammaDocId,n.document.clientID,r,i);case 4:if(a=t.sent){t.next=8;break}return console.warn("[compareClocks] Failed to fetch remote clock"),t.abrupt("return",!1);case 8:return t.prev=8,(u=((null==r?void 0:r.id.clock)||0)+((null==r?void 0:r.length)||0)-(((null==a?void 0:null===(c=a.lastKnownItem.id)||void 0===c?void 0:c.clock)||0)+((null==a?void 0:a.lastKnownItem.length)||0)))>0&&console.warn("[compareClocks] Clock drift detected",{diffLastItem:u}),l=i.clientCount-(a.itemSummary.clientCount||0),d=i.totalCount-(a.itemSummary.totalCount||0),l>0&&console.warn("[compareClocks] clientCount drift detected",{diffClientCount:l}),d>0&&console.warn("[compareClocks] totalCount drift detected",{diffTotalCount:d}),t.abrupt("return",0===l&&d<=o&&u<=o);case 20:t.prev=20,t.t0=t.catch(8),console.warn("[compareClocks] Failed to fetch remote clock");case 23:return t.abrupt("return",!1);case 24:case"end":return t.stop()}},t,null,[[8,20]])})),function(t,e,n){return r.apply(this,arguments)}),eG=function(t){var e=t.editor,n=t.yProvider,o=t.enabled,r=t.pollingInterval,i=(0,y.useState)(Date.now()),a=i[0],s=i[1],c=(0,y.useState)(0),u=c[0],l=c[1],d=(0,y.useState)(0),f=d[0],p=d[1],h=(0,Q.ye)("dataSyncClockDriftTolerance");return(0,y.useEffect)(function(){if(e&&n&&o){var t,i,a=!0,c=(t=(0,eU.Z)(eq().mark(function t(){var o;return eq().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.gammaDocId){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,eK(e,n,h);case 4:(o=t.sent)?s(Date.now()):console.warn("[useDataPersistenceSync_2] Clocks out of sync for doc",e.gammaDocId),requestIdleCallback(function(){l(function(t){return o?0:t+1}),p(function(t){return 0}),a&&(i=window.setTimeout(c,r))});case 7:case"end":return t.stop()}},t)})),function(){return t.apply(this,arguments)});return c(),function(){clearTimeout(i),a=!1}}},[e,n,o,r,h]),{errorCountClock:u,errorCountPMState:f,yDocLastSynced:a}},eQ=/^[\t\n -\}]$/,eY=function(t){var e=t.editor,n=t.pollingInterval,o=(0,y.useRef)(Date.now()),r=(0,y.useRef)(Date.now()),i=(0,y.useState)(0),a=i[0],s=i[1];return(0,y.useEffect)(function(){if(e){var t=function(t){!t.metaKey&&t.key.match(eQ)&&(o.current=Date.now())},i=function(t){t.transaction.docChanged&&(o.current=Date.now(),r.current=Date.now())};e.on("update",i),e.view.dom.addEventListener("keydown",t,!0);var a=setInterval(function(){r.current-o.current>500?(console.error("[useDataPersistenceSync_0] Delay to capture changes has exceeded threshold"),s(function(t){return t+1})):s(0)},n);return function(){clearInterval(a),e.off("update",i),e.view.dom.removeEventListener("keydown",t,!0)}}},[e,n]),a};function eW(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)}return n}function eJ(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?eW(Object(n),!0).forEach(function(e){(0,q.Z)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):eW(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var eX="data-sync-error-toast",e0=(0,ef.jsx)(ez.G,{icon:eR.xH,size:"2x"}),e1=(0,ef.jsx)(ez.G,{icon:eZ.ik,size:"2x"}),e2=function(t){var e=t.type,n=t.yDocLastSynced;return function(){return(0,ef.jsx)(es.k,{direction:"column",p:4,color:"white",bg:"warn"===e?"yellow.500":"red.500",borderRadius:"md",children:(0,ef.jsxs)(es.k,{alignItems:"center",children:["warn"===e?e0:e1,(0,ef.jsxs)(l.xu,{ml:3,children:[(0,ef.jsx)(h.x,{lineHeight:6,fontSize:"sm",fontWeight:"bold",children:"warn"===e?(0,ef.jsx)(eT.cC,{id:"IkN23t"}):(0,ef.jsx)(eT.cC,{id:"kXEHsK"})}),n&&(0,ef.jsx)(h.x,{lineHeight:6,fontSize:"sm",children:(0,ef.jsx)(eT.cC,{id:"VxWwaW",values:{0:(0,eN.Dw)(new Date(n).toISOString())}})}),"error"===e&&(0,ef.jsxs)(ef.Fragment,{children:[(0,ef.jsx)(e_.i,{pt:2}),(0,ef.jsx)(h.x,{lineHeight:6,fontSize:"sm",pt:2,children:(0,ef.jsx)(eT.cC,{id:"Pw5K5r"})})]})]})]})})}},e3=function(t){var e=t.editor,n=t.yProvider,o=t.enabled,r=(0,I.CG)(ey.Tf),i=(0,eL.Br)("comment"),a=(0,I.CG)(ey.q7),s=(0,y.useState)(2e4),c=s[0],u=s[1],l=(0,eH.z$)(),d=(0,eB.p)(),f=(0,D.SE)().user,p=(0,y.useRef)(),h=(0,Q.ye)("dataSyncErrorThreshold"),v=eY({editor:e,pollingInterval:c}),m=eG({editor:e,yProvider:n,enabled:o&&i,pollingInterval:c}),g=m.errorCountPMState,b=m.errorCountClock,w=m.yDocLastSynced,A={docSavedTime:a,yDocLastSynced:w,errorCountKeyboard:v,errorCountPMState:g,errorCountClock:b,clientID:null==n?void 0:n.document.clientID,userId:null==f?void 0:f.id},k=(0,y.useRef)(A);k.current=A;var S=b+g;(0,y.useEffect)(function(){u(0===S?2e4:4e3)},[S]);var P=o&&-1!==h&&S>h,M=o&&-1!==h&&S/h>2;return(0,y.useEffect)(function(){if(!P||r){if(d.isActive(eX)){d.close(eX);var t=p.current?+new Date-+p.current:void 0;null==l||l.trackDocEvent(eH.xW.DATA_SYNC_RECOVER,eJ(eJ({},k.current),{},{duration:t})),p.current=void 0}return}var n=e2({type:M?"error":"warn",yDocLastSynced:w});d.isActive(eX)?d.update(eX,{render:n}):(null==l||l.trackDocEvent(eH.xW.DATA_SYNC_ERROR,k.current),p.current=new Date,d({render:n,duration:null,id:eX})),M&&console.error("[useDataPersistenceSync] ERROR_THRESHOLD_EXCEEDED. docId:",null==e?void 0:e.gammaDocId)},[e,d,l,M,P,a,w,r]),M},e8=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=(0,y.useRef)(0),o=(0,y.useRef)(0),r=(0,y.useState)(!1),i=r[0],a=r[1],s=(0,y.useState)(0),c=s[0],u=s[1],l=(0,y.useState)(document.hidden),d=l[0],f=l[1],p=(0,y.useRef)(function(){if(n.current++,n.current>=e&&(console.warn("[useRateLimiter] Limit hit! (".concat(e," per ").concat(t/1e3,"s)")),i||(a(!0),u(function(t){return t+1}))),!o.current){var r=t/e;o.current=b.Zi(function(){n.current>0?n.current--:(a(!1),b.cv(o.current),o.current=0)},r)}});return(0,y.useEffect)(function(){var t=function(){f(document.hidden),p.current()};return document.addEventListener("visibilitychange",t),function(){return document.removeEventListener("visibilitychange",t)}},[]),[p.current,i,c,d]},e4=n(94659),e5=n(45650),e9=function(){return(0,ef.jsxs)(e4.g,{align:"flex-end",borderRadius:"base",shadow:"lg",p:3,bg:"gray.100",spacing:4,maxW:"300px",direction:"row",children:[(0,ef.jsxs)(l.xu,{children:[(0,ef.jsx)(h.x,{fontSize:"md",fontWeight:"bold",children:(0,ef.jsx)(eT.cC,{id:"oSUMyx"})}),(0,ef.jsxs)(h.x,{fontSize:"sm",children:[(0,ef.jsx)(eT.cC,{id:"CDva2g"})," ",(0,ef.jsx)("em",{children:(0,ef.jsx)(eT.cC,{id:"/vuJlA"})})," ","\uD83D\uDE0E"]})]}),(0,ef.jsx)(l.xu,{children:(0,ef.jsx)(e5.z,{size:"sm",onClick:function(){window.location.reload()},children:(0,ef.jsx)(eT.cC,{id:"HpK/8d"})})})]})},e7=function(t){var e=(0,eB.p)(),n=(0,y.useState)(!1),o=n[0],r=n[1];return(0,y.useEffect)(function(){if(t){var e=function(){var e=t.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION"),n=!!(e&&e>ei.bI);r(n),console[n?"warn":"debug"]("[SchemaVerifier] onUpdate",{requiredVersion:e,MY_VERSION:ei.bI,outdated:n})};return t.on("update",e),function(){t.off("update",e)}}},[t]),(0,y.useEffect)(function(){o&&!e.isActive("schema_outdated")&&e({id:"schema_outdated",duration:null,status:"warning",isClosable:!1,position:"bottom-left",render:e9})},[o,e]),o},e6=function(){return{SCHEMA_VERSION:String(ei.bI),SHARE_TOKEN:A.v.SHARE_TOKEN}},nt=(0,y.memo)(function(t){var e=t.doc,n=t.docId,o=t.onCreate,r=t.readOnly,i=void 0!==r&&r,a=t.scrollingParentSelector,C=t.hideForPreview,O=t.animationsExtensionEnabled,j=void 0!==O&&O,I=(0,P.bf)(),x=I.timeOnCreate,Z=I.timeOnSetupProvider,R=I.timeOnDownloadDoc,T=(0,y.useState)("connecting"),B=T[0],H=T[1],L=(0,y.useState)(!1),q=L[0],$=L[1],F=(0,y.useRef)(!1);F.current=q;var K=(0,y.useState)(!1),G=K[0],Q=K[1],Y=(0,y.useState)(!1),W=Y[0],J=Y[1],X=(0,y.useRef)([]),tt=(0,y.useState)(),te=tt[0],tn=tt[1],to=(0,y.useState)(),tr=to[0],ti=to[1],ta=(0,y.useState)(),ts=ta[0],tc=ta[1],tu=(0,y.useState)(),tl=tu[0],td=tu[1],tf=e7(tr);eA(te,ts),(0,er.jB)(te);var tp=e8(),th=(0,c.Z)(tp,4),tv=th[0],tm=th[1],tg=th[2],ty=th[3],tb=e&&e.organization&&e.organization.id,tw=(0,k.$gs)(),tA=tw.isConnected,tk=tw.setHocuspocusConnected,tS=e3({editor:te,yProvider:ts,enabled:tA&&!ty&&!i}),tP=(0,S.y)("debugLogging"),tM=(0,S.y)("debugCardViewed"),tD=(0,S.y)("offline"),tE=eP(tP),tC=tE.logMessages,tO=tE.logPerfMessage,tj=tE.dumpLog;(0,y.useEffect)(function(){tD&&ts&&!tl&&td(ex(n,ts.document,function(){"number"==typeof ts.document.getMap("SCHEMA_VERSION").get("REQUIRED_VERSION")&&($(!0),Q(!0))}))},[tD,ts,n,tl]),(0,D.$K)((0,y.useCallback)(function(){ts&&(ts.disconnect(),ts.configuration.parameters=e6(),setTimeout(function(){return ts.connect()},500))},[ts])),(0,eM.n)(te),(0,y.useEffect)(function(){tk(F.current||"connected"===B||ty)},[tk,B,ty]),(0,u.z)(function(){return tk(null)},[]),(0,y.useEffect)(function(){ts&&F.current&&"connected"===B&&(console.debug("[CollaborativeEditor] Force syncing on reconnect."),ts.forceSync())},[ts,B]),(0,y.useEffect)(function(){if(ts){var t,e=tg>10;if(tm){console.warn("[CollaborativeEditor] Attempted to re-connect while rate limited (".concat(tg," of ").concat(10,").")),ts.disconnect();return}if(e){console.error("[CollaborativeEditor - RECONNECT_RATE_LIMIT] Max rate limit violations reached (".concat(10,"). Will reload.")),setTimeout(function(){window.location.reload()},500);return}if(q)return ty?(console.debug("[CollaborativeEditor] Backgrounded, will wait ".concat(12e4,"s before disconnect")),t=b.iK(function(){console.debug("[CollaborativeEditor] Disconnecting after grace period"),ts.disconnect()},12e4)):(console.debug("[CollaborativeEditor] Foregrounded, so re-connecting"),ts.connect()),function(){t&&b.gr(t)}}},[ts,q,ty,tm,tg]),(0,y.useEffect)(function(){te&&!te.isDestroyed&&tb&&te.commands.setOrgId(tb)},[te,tb]),(0,y.useEffect)(function(){console.debug("[CollaborativeEditor] Creating yProvider for doc",n);var t=new w.QW({});ti(t),t.on("update",function(e){t.getMap("GammaPersistenceMeta").get("READY")&&(tO("Document data downloaded"),J(!0))}),tO("Setting up hocuspocus"),Z();var e=new m.Ui({url:A.v.MULTIPLAYER_WS_URL,name:n,document:t,forceSyncInterval:15e3,maxAttempts:25,parameters:e6(),onStatus:function(t){var e=t.status;console.debug("[CollaborativeEditor][onStatus]",{status:e}),H(e),"connected"===e?(tO("Hocuspocus connected"),$(!0)):"connecting"===e&&(tO("Hocuspocus connecting"),tv())},onSynced:function(){console.debug("[CollaborativeEditor] Provider synced"),Q(!0)},onDisconnect:function(t){var e=t.event;console.debug("[CollaborativeEditor][onDisconnect]",{event:e}),e.code===v.NI.code&&console.error('[CollaborativeEditor] Provider disconnected with "Unauthorized.code", which is unexpected.',e)}});return tc(e),A.v.DEBUG_ENABLED&&(window.gammaEditorProvider=e),X.current=[].concat((0,s.Z)(j?[V.F]:[]),[t9.zL,ee,er.$1.configure({scrollerSelector:a}),t$.configure({document:t}),_.configure({provider:e}),t0.configure({provider:e}),tx.configure({document:t}),tz,tH,tR.configure(),tL.NM,eo.W,z.configure({document:t}),U,t6.L,t3.Pi,t7.R,t8._g,en.Jn,g.ZT.configure({openDoubleQuote:!1,closeDoubleQuote:!1,openSingleQuote:!1,closeSingleQuote:!1}),t2.configure({scrollerSelector:a}),N.F,t5,M.p.configure({document:t})]),function(){console.warn("[CollaborativeEditor] Destroying yProvider for doc ",n),e.disconnect(),e.destroy(),delete window.gammaEditorProvider,tc(void 0),Q(!1),$(!1),J(!1),setTimeout(function(){if(e&&e.awareness)try{e.awareness.destroy()}catch(t){console.warn("[CollaborativeEditor] Error destroying awareness provider.")}})}},[n,tO,tv,a,Z]);var tI=!!(q&&G&&W);(0,y.useEffect)(function(){tI&&(tO("Is ready for TipTap"),R())},[tI,R,tO]);var tZ=!tD&&(!tA||tS);return(0,ef.jsxs)(l.xu,{display:void 0!==C&&C?"none":"block",w:"100%","data-testid":"collaborative-editor-wrapper",children:[tI&&tM&&(0,ef.jsx)(ep,{editor:te}),!te&&(0,ef.jsx)(l.xu,{flexDirection:"column",flex:"1",w:"100%",h:"var(--100vh)",bg:"gray.100",zIndex:"overlay","data-testid":"collaborative-editor-skeleton",mt:1,inset:0,children:(0,ef.jsx)(d.M,{h:"100%",children:(0,ef.jsxs)(f.K,{align:"center",children:[(0,ef.jsx)(p.$,{}),tC.map(function(t,e){var n=t.msg;return(0,ef.jsx)(h.x,{children:n},e)})]})})}),tI&&(0,ef.jsx)(E.y,{extensions:X.current,doc:e,docId:n,editorId:"main",onCreate:function(t){var e=t.editor;setTimeout(function(){tn(e),o&&o(e),requestAnimationFrame(function(){tO("Editor rendered"),x(),tj()})},10)},readOnly:tf||i||tZ,shouldSupportComments:!0,shouldSupportMenus:!0,scrollingParentSelector:a})]})}),ne=n(86297),nn=n(87880)},95173:function(t,e,n){n.d(e,{bI:function(){return r}}),n(36738);var o=new URLSearchParams(window.location.search),r=(o.get("SCHEMA_VERSION")?Number(o.get("SCHEMA_VERSION")):null)||85}}]);
//# sourceMappingURL=8163-62ba5a3b95c0c824.js.map